{{/*  
The image plugin is a partial that handles image resources.

Parameters:
- Src: The path to the image. 
    It can be a page resource (inside a page bundle) https://gohugo.io/methods/page/resources/
    or a global resource (inside the assets directory) https://gohugo.io/functions/resources/get/
    or a link to a remote resource, which can be cached if the site parameter is set https://gohugo.io/functions/resources/getremote/
- Resources: If the image is a page resource, this parameter is required. It is the .Resources of the page.
- Optim: optimisation parameter, defined like 
    {{- $optim := slice 
        (dict "Process" "resize 800x Center webp q75" "descriptor" "800w")
        (dict "Process" "resize 1200x Center webp q75" "descriptor" "1200w")
        (dict "Process" "resize 1600x Center webp q75" "descriptor" "1600w")
    -}}
    See https://gohugo.io/content-management/image-processing/ for more information.
*/}}


{{- $resource := (.Resources.Get .Src) | default (resources.Get .Src) | default nil -}}

{{- $cacheRemote := true -}}

{{- if not $resource | and (partial "function/isUrlRemote.html" (urls.Parse .Src)) | and $cacheRemote -}}
    {{- with $remoteResource := resources.GetRemote .Src -}}
        {{- with .Err -}}
            {{- warnf "%s" . -}}
        {{ else }}
            {{- if $remoteResource.ResourceType | eq "image" -}}
                {{- $resource = $remoteResource -}}
            {{- end -}}
    {{- end -}}
    {{- end -}}
{{- end -}}

{{- $optim := .Optim -}}
{{- $srcset := "" -}}
{{- if $optim | and $resource -}}
    {{ $srcsetSlice := slice -}}
    {{- range $optim -}}
        {{- if .Process -}}
            {{- $processed := $resource.Process .Process -}}
            {{- $srcsetSlice = $srcsetSlice | append (printf "%s %s" $processed.RelPermalink .descriptor) -}}
        {{- end -}}
    {{- end -}}
    {{- $srcset = delimit $srcsetSlice ", " -}}
{{- end -}}

{{- $src := $resource.RelPermalink | default .Src -}}
{{- $alt := .Alt | default .Title -}}
{{- $height := .Height | default $resource.Height | default "" -}}
{{- $width := .Width | default $resource.Width | default "" -}}

{{- if .Linked -}}
<a class="lightgallery" href="{{ $src }}" title="{{ .Title | default .Alt }}" data-thumbnail="{{ $src }}"{{ with .Caption }} data-sub-html="<h2>{{ . }}</h2>{{ with $.Title }}<p>{{ . }}</p>{{ end }}"{{ end }}{{ with .Rel }} rel="{{ . }}"{{ end }}>
{{- end -}}
<img {{ with .Class }}class="{{ . }}"{{ end }} {{ with .Loading }}loading="{{ . }}"{{ end }} src="{{ $src }}" {{ with $srcset }}srcset="{{ . }}"{{ end }} {{ with .Sizes }}sizes="{{ . }}"{{ end }} {{ with $alt }}alt=""{{ end }} {{ with $height }}height="{{ . }}"{{ end }} {{ with $width }}width="{{ . }}"{{ end }}>
{{- if .Linked -}}
</a>
{{- end -}}
{{/* 
{{- $remote := .Remote | default false -}}
{{- $optimize := .Optim | default false -}}
{{- $optimized := false -}}

{{- with dict "Path" .Src "Resources" .Resources "Remote" $remote | partial "function/getImage.html" -}}
    {{- $output := dict "Optim" $optimize "Image" . | partial "function/imageHandler.html" -}}
    {{- $small = $output.S -}}
    {{- $default = $output.M -}}
    {{- $large = $output.L -}}
    {{- $optimized = $output.Optimized -}}
    {{- $height = $default.Height -}}
    {{- $width = $default.Width -}}
{{- end -}}

{{- $alt := .Alt | default .Title | default .Src -}}
{{- $loading := .Loading | default "lazy" -}}

{{- with .Height -}}
    {{- $height = . -}}
{{- end -}}

{{- with .Width -}}
    {{- $width = . -}}
{{- end -}}

{{- if .Linked -}}
    <a class="lightgallery" href="{{ $large.RelPermalink | safeURL }}" title="{{ .Title | default $alt }}" data-thumbnail="{{ $small.RelPermalink | safeURL }}"{{ with .Caption }} data-sub-html="<h2>{{ . }}</h2>{{ with $.Title }}<p>{{ . }}</p>{{ end }}"{{ end }}{{ with .Rel }} rel="{{ . }}"{{ end }}>
{{- end -}}
        <img
            {{ with .Class }}class="{{ . }}"{{ end }}
            loading="{{ $loading }}"
            src="{{ $default.RelPermalink | safeURL }}"
            srcset="
            {{- if eq $optimized false -}}
                {{ $small.RelPermalink | safeURL }}, {{ $default.RelPermalink | safeURL }} 1.5x, {{ $large.RelPermalink | safeURL }} 2x
            {{- else -}}
                {{ $small.RelPermalink | safeURL }} {{ $small.Width }}w,
                {{ $default.RelPermalink | safeURL }} {{ $default.Width }}w,
                {{ $large.RelPermalink | safeURL }} {{ $large.Width }}w
            {{- end -}}
            "
            alt="{{ $alt }}"{{ with $height }} height="{{ . }}" {{ end }}{{ with $width }} width="{{ . }}" {{ end }}>
{{- if .Linked -}}
    </a>
{{- end -}}  */}}
